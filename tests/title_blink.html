<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>TitleBlink</title>
</head>
<body>
<button id="test">在一秒钟后调用“document.setHint('比赛开始了')”并在五秒钟后调用“document.setHint('')”</button>
<script>
//==================================================[标题闪烁功能]
var TitleBlink = function() {
  var originalTitle = document.title;
  var timer;
  var isOdd = true;
  return {
    /**
     * 让文档的标题闪烁。
     * @name TitleBlink.start
     * @function
     * @param {string} message 要闪烁的文字。
     *   由于标签的空间有限，不应写入太多的文字，否则可能显示不全。
     *   尽量使用中文，以避免文字闪烁时标题的长度发生变化。
     */
    start: function(message) {
      if (!timer) {
        timer = setInterval(function() {
          var symbol = isOdd ? '◆◇' : '◇◆';
          var text = isOdd ? message : new Array(message.length + 1).join('　');
          isOdd = !isOdd;
          document.title = symbol + text + symbol.split('').reverse().join('');
        }, 500);
      }
    },
    /**
     * 让文档的标题停止闪烁。
     * @name TitleBlink.stop
     * @function
     * @description
     *   文档的标题会恢复到调用 TitleBlink.start 之前的状态。
     */
    stop: function() {
      if (timer) {
        clearInterval(timer);
        timer = undefined;
        document.title = originalTitle;
      }
    }
  };
}();

//==================================================[自动触发器]
(function() {
  function onactivate() {
    TitleBlink.stop();
  }

  function ondeactivate() {
    if (document.hint) {
      TitleBlink.start(document.hint);
    }
  }

  document.hint = '';
  // 默认当前页为激活状态。
  document.isActive = false;
  var timer;
  var events = '';
  var checkEvents = function(events) {
    // Safari 浏览器非激活，监控页在前，直接到达其他页的情况。
    if (events === '1011') {
      events = '0';
    }
    var lastEvent = events.slice(-1);
    if (document.isActive && lastEvent === '0') {
      document.isActive = false;
      ondeactivate();
    }
    if (!document.isActive && lastEvent === '1') {
      document.isActive = true;
      onactivate();
    }
  };
  var collectEvents = function(e) {
    if (!timer) {
      timer = setTimeout(function() {
        checkEvents(events);
        timer = undefined;
        events = '';
      }, 100);
    }
    events += (e.type === 'focus' || e.type === 'focusin') ? 1 : 0;
  };

  if (window.attachEvent) {
    document.attachEvent('onfocusin', collectEvents);
    document.attachEvent('onfocusout', collectEvents);
  } else {
    window.addEventListener('focus', collectEvents);
    window.addEventListener('blur', collectEvents);
  }

})();

//==================================================[document.setHint]
/**
 * 设定要在标题显示的提示信息。
 * @name document.setHint
 * @function
 * @param {string} hint 提示信息。
 *   如果为空，则取消设定。
 * @description
 *   提示信息只会在当前窗口非活动时显示。
 */
document.setHint = function(hint) {
  if (hint) {
    document.hint = hint;
    if (!document.isActive) {
      TitleBlink.start(document.hint);
    }
  } else {
    document.hint = '';
    if (!document.isActive) {
      TitleBlink.stop();
    }
  }
};

//==================================================[Test]
document.getElementById('test').onclick = function() {
  setTimeout(function() {
    document.setHint('比赛开始了');
  }, 1000);
  setTimeout(function() {
    document.setHint('');
  }, 5000);
};


</script>
</body>
</html>
