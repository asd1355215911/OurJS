<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ajax</title>
<script src="../../our.js"></script>
<script src="../../scripts/framework.js"></script>
<script src="../../src/utilities/logger.js"></script>
<style>
blockquote { margin: 5px 0 0; padding: 5px; border: 1px solid gainsboro; }
</style>
</head>
<body>
<div id="content">
  <h1>Ajax</h1>

  <h2>Request</h2>
  <fieldset>
    <legend>使用 Request 进行同域请求</legend>
    <div id="logger" style="height: 350px;"></div>
    <blockquote>
      <button id="send_txt">send (data.txt) x 3 times</button>
      <button id="abort_txt">abort (data.txt)</button>
      <br>
      <button id="send_xml">send (data.xml)</button>
      <button id="abort_xml">abort (data.xml)</button>
    </blockquote>
  </fieldset>
  <script>
  (function() {
    var logger = new Logger($('#logger'), true);

    var times = 1;
    var requestTXT = new Request('data.txt', {
      useCache: false,
      minTime: 400,
      maxTime: 600,
      requestParser: function(data) {
        return typeof data === 'string' ? data : JSON.stringify(data);
      }
    })
        .on('start', function(e) {
          logger.log('<strong>' + e.type + '</strong>' + e.data);
        })
        .on('finish', function(e) {
          logger.log('<strong>' + e.type + '</strong>status=<var>' + e.status + '</var> statusText=<var>' + e.statusText + '</var> text=<var>' + e.text + '</var>');
        })
        .on('finish', function(e) {
          if (times++ < 3) {
            this.send('{"times": ' + times + '}');
            if (times === 2) {
              this.abort();
            }
          } else {
            times = 1;
          }
        });
    $('#send_txt').on('click', function() {
      requestTXT.send('{"times": 1}');
    });
    $('#abort_txt').on('click', function() {
      requestTXT.abort();
    });

    var requestXML = new Request('data.xml', {
      method: 'get',
      useCache: true,
      minTime: 500,
      maxTime: 600
    })
        .on('start', function(e) {
          logger.log('<em>' + e.type + '</em>' + e.data);
        })
        .on('finish', function(e) {
          logger.log('<em>' + e.type + '</em>status=<var>' + e.status + '</var> statusText=<var>' + e.statusText + '</var>' + (e.xml ? ' nodeName=<var>' + e.xml.documentElement.nodeName + '</var>' : ''));
        });
    $('#send_xml').on('click', function() {
      requestXML.send();
    });
    $('#abort_xml').on('click', function() {
      requestXML.abort();
    });

  })();
  </script>

  <h2>JSONPRequest</h2>
  <fieldset>
    <legend>使用 JSONPRequest 进行跨域请求</legend>
    <div id="logger_jsonprequest" style="height: 350px;"></div>
    <blockquote>
      <button id="send">send</button>
    </blockquote>
  </fieldset>
  <script>
  (function() {
    var logger = new Logger($('#logger_jsonprequest'), true);

    var jsonpRequest = new JSONPRequest('http://www.highcharts.com/samples/data/jsonp.php?filename=aapl-c.json')
        .on('send, start', function(e) {
          logger.log('<em>' + e.type + '</em>' + e.data);
        })
        .on('finish', function(e) {
          logger.log('<em>' + e.type + '</em>' + e.data.length);
        });

    $('#send').on('click', function() {
      jsonpRequest.send('a=100000');
    });

  })();
  </script>

</div>
</body>
</html>
