<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ajax</title>
<script src="../../our.js"></script>
<script src="../../scripts/framework.js"></script>
<script src="../../src/addons/logger.js"></script>
<style>
blockquote { margin: 5px 0 0; padding: 5px; border: 1px solid gainsboro; }
</style>
</head>
<body>
<div id="content">
  <h1>Ajax</h1>

  <h2>Request</h2>
  <fieldset>
    <legend>使用 Request 对象进行异步请求</legend>
    <div id="logger" style="height: 350px;"></div>
    <blockquote>
      <button id="send_txt">send (data.txt) x 5 times</button>
      <button id="abort_txt">abort (data.txt)</button>
      <br>
      <button id="send_xml">send (data.xml)</button>
      <button id="abort_xml">abort (data.xml)</button>
    </blockquote>
  </fieldset>
  <script>
  execute(function($) {
    var logger = new Logger($('#logger'), true);

    var times = 0;
    var requestTXT = new Request('data.txt', {
      useCache: false,
      minTime: 400,
      maxTime: 600,
      requestParser: function(data) {
        return typeof data === 'string' ? data : JSON.stringify(data);
      }
    })
        .on('start', function(e) {
          logger.log('<strong>start</strong>' + e.data);
        })
        .on('finish', function(e) {
          logger.log('<strong>finish</strong>status=<var>' + e.status + '</var> statusText=<var>' + e.statusText + '</var> text=<var>' + e.text + '</var>');
        })
        .on('finish', function(e) {
          if (times++ < 5) {
            this.send('{"times": ' + times + '}');
            if (times === 1 || times === 3) {
              this.abort();
            }
          } else {
            times = 0;
          }
        });
    $('#send_txt').on('click', function() {
      requestTXT.send('{"type": "wait", "orderByTime": "true", "pageSize": 10, "pageIndex": 1}');
    });
    $('#abort_txt').on('click', function() {
      requestTXT.abort();
    });

    var requestXML = new Request('data.xml', {
      method: 'get',
      useCache: true,
      minTime: 500,
      maxTime: 600
    })
        .on('start', function(e) {
          logger.log('<em>start</em>' + e.data);
        })
        .on('finish', function(e) {
          logger.log('<em>finish</em>status=<var>' + e.status + '</var> statusText=<var>' + e.statusText + '</var>' + (e.xml ? ' nodeName=<var>' + e.xml.documentElement.nodeName + '</var>' : ''));
        });
    $('#send_xml').on('click', function() {
      requestXML.send();
    });
    $('#abort_xml').on('click', function() {
      requestXML.abort();
    });

  });
  </script>

</div>
</body>
</html>
