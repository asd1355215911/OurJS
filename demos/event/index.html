<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>事件</title>
<script src="../../our.js"></script>
<script src="../../scripts/framework.js"></script>
<script src="../../src/addons/logger.js"></script>
<style>
blockquote { margin: 5px 0 0; padding: 5px; border: 1px solid gainsboro; }
button samp { padding: 0 5px; border-radius: 3px; background: tomato; }
.container { padding: 5px 0 5px 5px; border: 2px solid crimson; background: whitesmoke; *zoom: 1; }
.container bdo,
.container cite,
.container dfn,
.container kbd,
.container span,
.container var { float: left; display: block; width: 100px; height: 30px; margin: 0 5px 5px 0; background: gainsboro; line-height: 30px; text-align: center; cursor: default; -display: inline; }
.container p { clear: both; height: 30px; margin: 0 5px 0 0; background: darkseagreen; font: 12px/30px Verdana; text-align: center; cursor: default; }
dl { float: left; width: 220px; margin: 0 5px; border: 1px solid silver; background: #252525; color: #8CC; -display: inline; }
dt { height: 16px; padding: 5px; border-bottom: 1px solid silver; background: whitesmoke; color: #333; text-align: center; line-height: 16px; }
dd { height: 128px; padding: 5px; line-height: 1; }
dd p { margin: 2px; padding: 2px; }
dd em { display: inline-block; padding: 0 1px; border: 1px solid; border-radius: 3px; }
dd em.true { color: #A5C261; }
dd em.false { color: #FF6767; }

#mouse { height: 180px; background: crimson; }
#div p,
#mouse div { height: 20px; background: #ffd711; line-height: 20px; cursor: default; }
#container { position: relative; height: 150px; background: #f5f5f5; }
#drag { position: absolute; left: 0; top: 0; width: 160px; height: 120px; padding: 3px; border: 2px solid lightsteelblue; background: lightsteelblue; cursor: default; }
#drag.dragging { border-color: dodgerblue; }
.focusin { background: silver; }
</style>
</head>
<body>
<div id="content">
  <h1>事件</h1>

  <h2>添加和删除事件监听器</h2>

  <!-- 多监听器添加及删除 { -->
  <fieldset>
    <legend>多监听器添加及删除</legend>
    <div id="on_off_logger" style="float: right; width: 407px;"></div>
    <div style="float: left; width: 534px;">
      <button id="foo"><samp style="background: mediumseagreen;">~foo~</samp></button>
      <button id="bar"><samp>-bar-</samp></button>
      <blockquote>
        <button id="add">为<samp>bar</samp>添加监听器 logId 和 logText</button>
        <br>
        <button id="remove_log_id">解除<samp>bar</samp>的监听器 logId</button>
        <br>
        <button id="remove_log_html">解除<samp>bar</samp>的监听器 logText</button>
      </blockquote>
    </div>
  </fieldset>
  <script>
  execute(function($) {
    var $logger = $('#on_off_logger');
    var logger = new Logger($logger.setStyle('height', $logger.getNextSibling().offsetHeight - 2), true);

    var logId = function() {
      logger.log('<em>logId</em>' + this.id);
    };
    var logText = function() {
      logger.log('<em>logText</em>' + this.innerText);
    };

    $('#foo')
        .on('click', logId)
        .on('click', logText);
    $('#add').on('click', function() {
      $('#bar')
          .on('click', logId)
          .on('click.html', logText);
      logger.log('已为“bar”添加监听器<strong>logId</strong>和<strong>logText</strong>。');
    });

    $('#remove_log_id').on('click', function() {
      $('#bar').off('click', logId);
      logger.log('已删除“bar”的所有<strong>logId</strong>监听器。');
    });
    $('#remove_log_html').on('click', function() {
      $('#bar').off('click.html', logText);
      logger.log('已删除“bar”的所有<strong>logText</strong>监听器。');
    });

  });
  </script>
  <!-- } 多监听器添加及删除 -->

  <h2>事件传播</h2>

  <!-- 事件传播 { -->
  <fieldset>
    <legend>红色边框的元素上添加了 click 事件监听器</legend>
    <div id="propagation_logger" style="float: right; width: 407px;"></div>
    <div style="float: left; width: 534px;">
      <div id="propagation" class="container">
        <bdo>bdo</bdo><cite>cite</cite><dfn>dfn</dfn><kbd>kbd</kbd><span>span</span><var>var</var>
        <p id="propagation_stop">p</p>
      </div>
      <blockquote>
        <label><input id="stop_propagation" type="checkbox" style="vertical-align: text-bottom;"> 取消以上P元素的事件传播</label>
      </blockquote>
    </div>
  </fieldset>
  <script>
  execute(function($) {
    var $logger = $('#propagation_logger');
    var logger = new Logger($logger.setStyle('height', $logger.getNextSibling().offsetHeight - 2), true);

    $('#propagation').on('click', function(e) {
      logger.log('<strong>' + e.target.nodeName + '</strong> » <em>' + this.nodeName + '</em>');
    });

    $('#propagation_stop').on('click', function(e) {
      if ($('#stop_propagation').checked) {
        e.stopPropagation();
      }
    });

  });
  </script>
  <!-- } 事件传播 -->

  <h2>事件代理</h2>

  <!-- 事件代理 { -->
  <fieldset>
    <legend>红色边框的元素为其所有标签名为 DFN 的后代元素代理监听 mouseenter 和 mouseleave 事件</legend>
    <div id="relay" class="container" style="padding-bottom: 0; *padding-bottom: 5px;">
      <bdo>bdo</bdo><dfn><strong>dfn</strong></dfn><cite>cite</cite><dfn><em>dfn</em></dfn><kbd>kbd</kbd><dfn><sup>dfn</sup></dfn><span>span</span><dfn><sub>dfn</sub></dfn>
    </div>
  </fieldset>
  <script>
  execute(function($) {
    $('#relay')
        .on('mouseenter:relay(dfn)', function() {
          this.morph({width: 150}).highlight();
        })
        .on('mouseleave:relay(dfn)', function() {
          this.morph({width: 100}).highlight('red', 'color');
        });
  });
  </script>
  <!-- } 事件代理 -->

  <h2>事件对象的属性</h2>

  <!-- 事件对象的属性 { -->
  <fieldset>
    <legend>不同类型的事件对象有不同的属性</legend>
    <dl>
      <dt>鼠标滚轮事件特有的属性</dt>
      <dd id="mouse_wheel"></dd>
    </dl>
    <dl>
      <dt>鼠标事件特有的属性</dt>
      <dd id="mouse_move"></dd>
    </dl>
    <dl>
      <dt>鼠标按键事件特有的属性</dt>
      <dd id="mouse_press"></dd>
    </dl>
    <dl>
      <dt>鼠标和键盘事件共有的属性</dt>
      <dd id="key_press"></dd>
    </dl>
  </fieldset>
  <script>
  execute(function($) {
    var getText = function(event, properties) {
      var text = '';
      properties.forEach(function(property) {
        var value = event[property];
        if (typeof value === 'boolean') {
          value = '<em class="' + value + '">' + value + '</em>';
        }
        text += '<p>' + property + ': ' + value + '</p>';
      });
      return text;
    };

    $('#mouse_wheel').on('mousewheel', function(e) {
      this.innerHTML = getText(e, 'wheelUp wheelDown'.split(' '));
      // IE8 会自动 preventDefault，因此建议加上，以确保各浏览器中行为一致。
      e.preventDefault();
    });

    document
        .on('mousemove', function(e) {
          $('#mouse_move').innerHTML = getText(e, 'clientX clientY screenX screenY pageX pageY'.split(' '));
        })
        .on('mousedown', function(e) {
          $('#mouse_press').innerHTML = getText(e, 'leftButton middleButton rightButton'.split(' '));
        })
        .on('mousemove, mousedown, keypress', function(e) {
          $('#key_press').innerHTML = getText(e, 'which ctrlKey altKey shiftKey metaKey'.split(' '));
        });

    // 测试。
    $('#mouse_press').on('mouseover', function() {
      this.fire('mousedown', {leftButton: '此时的属性值是由 fire 方法传递过来的。', middleButton: '系统事件并未触发。', rightButton: '区别方式见 API 文档。'});
    });

  });
  </script>
  <!-- } 事件对象的属性 -->

  <h2>事件的兼容处理</h2>

  <!-- focusin/focusout/input/change { -->
  <fieldset>
    <legend>focusin/focusout/input/change</legend>
    <div id="form_logger" style="float: right; width: 407px;"></div>
    <div style="float: left; width: 534px;">
      <div id="form_events" style="padding: 5px; border: 1px solid silver; background: whitesmoke;">
        <input type="checkbox" value="checkbox_1" checked>
        <input type="checkbox" value="checkbox_2">
        <input type="checkbox" value="checkbox_3"><br>
        <input name="state" type="radio" value="radio_1" checked>
        <input name="state" type="radio" value="radio_2">
        <input name="state" type="radio" value="radio_3"><br>
        <input type="text" value="" class="input" style="width: 250px; border: 1px solid silver;"><br>
        <input type="password" value="" class="input" style="width: 250px; border: 1px solid silver;"><br>
        <textarea class="input" style="width: 250px; height: 50px; border: 1px solid silver; resize: none;"></textarea>
      </div>
      <blockquote>
        <label><input id="disable_focus_logging" type="checkbox" style="vertical-align: text-bottom;"> 输出 focusin/focusout 的日志信息</label>
      </blockquote>
    </div>
  </fieldset>
  <script>
  execute(function($) {
    var $logger = $('#form_logger');
    var logger = new Logger($logger.setStyle('height', $logger.getNextSibling().offsetHeight - 2), true);

    var $formEvents = $('#form_events');
    $formEvents.on('focusin, focusout', function(e) {
      if ($('#disable_focus_logging').checked) {
        logger.log('<strong>' + e.type + '</strong>');
      }
      this.morph({backgroundColor: e.type === 'focusin' ? 'gold' : 'whitesmoke'})
    });
    $formEvents.find('input[type=checkbox], input[type=radio]').forEach(function($control) {
      $control.on('change', function(e) {
        logger.log('<strong>' + e.type + '</strong>' + this.nodeName + ' value=<var>' + this.value + '</var> checked=<var>' + this.checked + '</var>');
      });
    });
    $formEvents.find('input[type=text], input[type=password], textarea').forEach(function($control) {
      $control.on('input', function(e) {
        logger.log('<strong>' + e.type + '</strong>' + this.type + ' value=<var>' + this.value + '</var>');
      });
    });

  });
  </script>
  <!-- } focusin/focusout/input/change -->


  <!-- 拖动事件 { -->
  <fieldset>
    <legend>拖动事件</legend>
    <div id="container">
      <div id="drag">
        <div id="d41" class="draggable">Draggable</div>
        <div id="d42" class="draggable">Draggable</div>
        <div id="i_gray">[灰]</div>
        <div id="i_blue">[蓝]</div>
      </div>
    </div>
    <button id="freez">解除以上蓝方块拖动</button>
    <button id="clear">解除以上蓝方块代理</button>
  </fieldset>
  <script>
  var $ = document.$;
  //--------------------------------------------------[拖动事件]
  var $container = $('#container');
  var $drag = $('#drag');

  // 自身。
  var currentX = 0;
  var currentY = 0;
  var maxX = $container.offsetWidth - $drag.offsetWidth;
  var maxY = $container.offsetHeight - $drag.offsetHeight;
  $drag.on('mousedragstart.f', function() {
    currentX = $drag.offsetLeft;
    currentY = $drag.offsetTop;
    this.addClass('mousedragging');
  })
      .on('mousedrag.f', function(e) {
        var x = Math.max(Math.min(currentX + e.offsetX, maxX), 0);
        var y = Math.max(Math.min(currentY + e.offsetY, maxY), 0);
        this.setStyles({left: x + 'px', top: y + 'px'});
        $('#i_blue').innerHTML = '[蓝]' + x + ':' + y;
      })
      .on('mousedragend.f', function(e) {
        this.removeClass('mousedragging');
      });
  $container.on('mousedrag', function(e) {
    $('#i_gray').innerHTML = '[灰]' + e.offsetX + ':' + e.offsetY;
  });

  // 代理。
  $drag.on('mousedragstart.c:relay(.draggable)', function(e) {
    this.setStyle('background', 'greenyellow').innerHTML = 'START';
//    return false;
  })
      .on('mousedrag.c:relay(.draggable)', function(e) {
        this.innerHTML = e.offsetX + ':' + e.offsetY;
      })
      .on('mousedragend.c:relay(.draggable)', function(e) {
        this.setStyle('background', 'transparent').innerHTML = 'END';
      });

  // 解除。
  $('#freez').on('click', function() {
    $drag.off('mousedragstart.f, mousedrag.f, mousedragend.f');
  });

  $('#clear').on('click', function() {
    $drag.off('mousedragstart.c:relay(.draggable), mousedrag.c:relay(.draggable), mousedragend.c:relay(.draggable)');
  });

  /*
   $drag.on('mousedragstart', function(e) {
   console.log('::dragstart::', e.target, e.offsetX, e.offsetY);
   })
   .on('mousedrag', function(e) {
   console.log('::drag::', e.offsetX, e.offsetY);
   })
   .on('mousedragend', function(e) {
   console.log('::dragend::', e.offsetX, e.offsetY);
   });
   */

  </script>
  <!-- } 拖动事件 -->

  <!-- 鼠标进入、离开 -->
  <fieldset>
    <legend>鼠标进入、离开</legend>
    <div id="mouse">
      <div id="d51"></div>
      <div id="d52"></div>
      <div id="d53"></div>
      <cite>cite</cite><dfn>dfn</dfn><kbd>kbd</kbd><samp>samp</samp><var>var</var>
      <p id="inner">p</p></div>
  </fieldset>

  <script>


  //--------------------------------------------------[鼠标进入、离开]
  var $d51 = $('#d51');
  var $mouse = $('#mouse');
  var $inner = $('#inner');

  function showMessage($target, message) {
    if ($target.innerHTML.length + message.length > 60) {
      $target.innerHTML = '';
    }
    $target.innerHTML += message;
  }

  function over(event) {
    showMessage($d51, '|Over');
    console.log(event.originalEvent);
  }

  function out(event) {
    showMessage($d51, '|Out');
  }

  function enter(event) {
    showMessage($(this.nodeName === 'DIV' ? '#d52' : '#d53'), '|Enter:' + this.nodeName);
    console.log(event.type);
  }

  function leave(event) {
    showMessage($(this.nodeName === 'DIV' ? '#d52' : '#d53'), '|Leave:' + this.nodeName);
    console.log(event.type);
  }

  $mouse.on('mouseover', over);
  $mouse.on('mouseout', out);
  $mouse.on('mouseenter', enter);
  $mouse.on('mouseleave', leave);
  $inner.on('mouseenter', enter);
  $inner.on('mouseleave', leave);

  /*
   .on('mousedown.one', function(e) {
   e.preventDefault();
   })
   .on('mousedown.two', function(e) {
   e.stopPropagation();
   })
   .on('mousedown.three', function(e) {
   e.stopImmediatePropagation();
   })
   .off('mousedown.two, mousedown.three');
   */
  </script>

</div>
</body>
</html>
